name: Publish & Release

on:
    push:
        branches: [main]

jobs:
    generate_release_note:
        name: Generate Release Note
        runs-on: ubuntu-latest
        permissions:
            contents: read
        outputs:
            final_message: ${{ steps.run_codex.outputs.final-message }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v5
              with:
                  fetch-depth: 0
            - name: Check if version changed
              id: version-check
              uses: EndBug/version-check@v2
              with:
                  diff-search: true
                  file-name: package.json
            - name: Last Release Sha
              id: last-release
              if: steps.version-check.outputs.changed == 'true'
              uses: actions/github-script@v7
              with:
                  script: |
                      const { data: releases } = await github.rest.repos.listReleases({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          per_page: 1
                      });
                      if (releases.length > 0) {
                          const tagName = releases[0].tag_name;
                          const { data: ref } = await github.rest.git.getRef({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              ref: `tags/${tagName}`
                          });
                          core.setOutput('sha', ref.object.sha);
                      } else {
                          const { data: repo } = await github.rest.repos.get({
                              owner: context.repo.owner,
                              repo: context.repo.repo
                          });

                          core.setOutput('sha', repo.root_commit_sha);
                      }
            - name: Run Codex
              id: run_codex
              if: steps.version-check.outputs.changed == 'true'
              uses: openai/codex-action@v1
              with:
                  openai-api-key: ${{ secrets.OPENAI_API_KEY }}
                  prompt: |
                      Generate a comprehensive release note in markdown format for the changes between two versions:
                        - Current Version Head: ${{ github.sha }}
                        - Last Version: ${{ steps.last-release.outputs.sha }}
                        - Current Version Number: ${{ steps.get-version.outputs.version }}
    release:
        name: Create Release
        runs-on: ubuntu-latest
        needs: generate_release_note
        if: needs.generate_release_note.outputs.final_message != ''
        permissions:
            contents: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v5
            - name: Get version from package.json
              id: get-version
              run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: v${{ steps.get-version.outputs.version }}
                  name: better-grpc v${{ steps.get-version.outputs.version }}
                  body: ${{ needs.generate_release_note.outputs.final_message }}
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    publish:
        name: Publish NPM Package
        runs-on: ubuntu-latest
        needs: release
        steps:
            - name: Checkout code
              uses: actions/checkout@v5
            
            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
            
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  registry-url: 'https://registry.npmjs.org'
            
            - name: Install dependencies
              run: bun install
            
            - name: Publish to npm
              run: npm publish
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        